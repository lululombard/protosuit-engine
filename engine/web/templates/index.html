<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protosuit Engine Control</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- MQTT.js library for direct MQTT over WebSockets -->
    <script src="{{ url_for('static', filename='js/vendor/mqtt.min.js') }}"></script>
</head>

<body>
    <header>
        <h1>PROTOSUIT ENGINE</h1>
        <div class="title-slash">
            <svg width="560" height="14" xmlns="http://www.w3.org/2000/svg">
                <!-- Half-filled diagonal hazard stripes (ending diagonally, not squared) -->
                <g transform="skewX(-45)">
                    <!-- Amber stripes -->
                    <rect x="0" y="0" width="320" height="14" fill="#f39c12" />
                    <rect x="350" y="0" width="30" height="14" fill="#f39c12" />
                    <rect x="410" y="0" width="30" height="14" fill="#f39c12" />
                    <rect x="470" y="0" width="30" height="14" fill="#f39c12" />
                    <rect x="530" y="0" width="30" height="14" fill="#f39c12" />
                </g>
            </svg>
        </div>
    </header>

    <div class="grid-container">
        <!-- LEFT COLUMN -->
        <div class="left-column">
            <!-- Status -->
            <section class="panel">
                <h2>Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="label">CONNECTION:</span>
                        <span id="statusText" class="value">Connecting...</span>
                    </div>
                    <div class="status-item">
                        <span class="label">ANIMATION:</span>
                        <span id="currentAnimation" class="value">Unknown</span>
                    </div>
                    <div class="status-item">
                        <span class="label">RENDERER FPS:</span>
                        <span id="rendererFps" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">LEFT RES:</span>
                        <span id="leftRes" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">RIGHT RES:</span>
                        <span id="rightRes" class="value">--</span>
                    </div>
                </div>
                <div class="button-group">
                    <button onclick="window.location.href='/bluetooth'">BT</button>
                    <button onclick="window.location.href='/networking'">Network</button>
                    <button onclick="window.location.href='/cast'">Cast</button>
                    <button onclick="window.location.href='/controller'">Controller</button>
                </div>
            </section>

            <!-- Animation Control -->
            <section class="panel">
                <h2>Animation Control</h2>
                <div id="animationButtons" class="button-grid">
                    <p><em>Waiting for renderer...</em></p>
                </div>
            </section>

            <!-- Presets -->
            <section class="panel">
                <h2>Presets</h2>
                <div id="presetsList">
                    <p><em>No presets saved</em></p>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="saveCurrentAsPreset()">Save Current as Preset</button>
                </div>
            </section>

            <!-- File Browser -->
            <section class="panel">
                <h2>File Browser</h2>
                <div class="file-controls">
                    <div class="button-group">
                        <button onclick="refreshFiles()">ðŸ”„ Refresh</button>
                        <button onclick="killAudio()">ðŸ”ª Kill Audio</button>
                        <button onclick="killVideo()">ðŸ”ª Kill Video</button>
                        <button onclick="killExec()">ðŸ”ª Kill Exec</button>
                    </div>
                </div>
                <div class="volume-control"
                    style="margin: 10px 0; padding: 10px; border: 1px solid #444; border-radius: 5px;">
                    <label for="volumeSlider" style="display: block; margin-bottom: 5px;">
                        ðŸ”Š Volume: <span id="volumeValue">50</span>%
                    </label>
                    <input type="range" id="volumeSlider" min="0" max="100" step="1" value="50" style="width: 100%;"
                        oninput="setVolume(this.value)" onmousedown="isVolumeSliderDragging = true"
                        onmouseup="onVolumeSliderRelease()" ontouchstart="isVolumeSliderDragging = true"
                        ontouchend="onVolumeSliderRelease()">
                </div>
                <div id="fileList" class="file-list">
                    <p><em>Waiting for launcher status...</em></p>
                </div>
            </section>

            <!-- Custom Command -->
            <section class="panel">
                <h2>Custom Command</h2>
                <div class="input-group">
                    <input type="text" id="customTopic" placeholder="protogen/fins/launcher/start/video">
                    <input type="text" id="customPayload" placeholder="rickroll.mp4">
                    <button onclick="sendCustom()">Send Command</button>
                </div>
            </section>


        </div>

        <!-- RIGHT COLUMN -->
        <div class="right-column">
            <!-- System Status (RPi metrics from systembridge) -->
            <section class="panel">
                <h2>System</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="label">CPU:</span>
                        <span id="sysCpu" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">MEMORY:</span>
                        <span id="sysMem" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">DISK:</span>
                        <span id="sysDisk" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">TEMPERATURE:</span>
                        <span id="sysTemp" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">CPU FREQ:</span>
                        <span id="sysFreq" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">PI FAN:</span>
                        <span id="sysFan" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">UPTIME:</span>
                        <span id="sysUptime" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">THROTTLE:</span>
                        <span id="sysThrottle" class="value">--</span>
                    </div>
                </div>

                <!-- Pi Fan Curve -->
                <div style="margin-top: 15px; padding: 10px; border: 1px solid #444; border-radius: 5px;">
                    <a href="#" onclick="togglePiFanCurve(); return false;" style="font-size: 0.85em; color: #888;">
                        <span id="piFanCurveToggleIcon">â–¶</span> Pi Fan Curve
                    </a>
                    <div id="piFanCurveEditor" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span></span>
                            <button onclick="resetPiFanCurve()" style="font-size: 0.8em; padding: 2px 8px;">Reset Defaults</button>
                        </div>
                        <table id="piFanCurveTable" style="width: 100%; margin-top: 5px; font-size: 0.85em;">
                            <thead>
                                <tr><th style="text-align: left;">Temp (C)</th><th>Fan %</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <button onclick="savePiFanCurve()" style="width: 100%; margin-top: 10px;">Save Curve</button>
                    </div>
                </div>

                <!-- Throttle Temperature -->
                <div style="margin-top: 10px; padding: 10px; border: 1px solid #444; border-radius: 5px;">
                    <a href="#" onclick="toggleThrottleTemp(); return false;" style="font-size: 0.85em; color: #888;">
                        <span id="throttleTempToggleIcon">â–¶</span> Throttle Temperature
                    </a>
                    <div id="throttleTempEditor" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                        <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85em;">
                            <span>Throttle at</span>
                            <input type="number" id="throttleTempInput" style="width: 60px; padding: 4px;" min="60" max="90" step="1">
                            <span>Â°C</span>
                            <button onclick="saveThrottleTemp()" style="padding: 4px 12px;">Save</button>
                        </div>
                        <small style="color: #888; display: block; margin-top: 5px;">Requires reboot to take effect</small>
                    </div>
                </div>

                <!-- System Controls -->
                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="reloadConfig()">Reload Config</button>
                    <button onclick="systemReboot()" style="border-color: #ff6b6b; color: #ff6b6b;">Reboot</button>
                    <button onclick="systemShutdown()" style="border-color: #ff6b6b; color: #ff6b6b;">Shutdown</button>
                </div>
            </section>

            <!-- Visor Status (ESP32 sensors) -->
            <section class="panel">
                <h2>Visor Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="label">ESP32:</span>
                        <span id="espStatus" class="value">Disconnected</span>
                    </div>
                    <div class="status-item">
                        <span class="label">TEMPERATURE:</span>
                        <span id="visorTemp" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">HUMIDITY:</span>
                        <span id="visorHumidity" class="value">--</span>
                    </div>
                    <div class="status-item">
                        <span class="label">FAN RPM:</span>
                        <span id="visorRpm" class="value">--</span>
                    </div>
                </div>
                <div class="fan-control" style="margin-top: 15px; padding: 10px; border: 1px solid #444; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="fanSlider">
                            Fan Speed: <span id="fanSpeedValue">50</span>%
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="fanAutoMode" onchange="setFanMode(this.checked)">
                            Auto
                        </label>
                    </div>
                    <input type="range" id="fanSlider" min="0" max="100" step="5" value="50" style="width: 100%;"
                        oninput="updateFanSpeedDisplay(this.value)" onchange="setFanSpeed(this.value)">

                    <div style="margin-top: 10px;">
                        <a href="#" onclick="toggleFanCurveEditor(); return false;" style="font-size: 0.85em; color: #888;">
                            <span id="fanCurveToggleIcon">â–¶</span> Fan Curve Settings
                        </a>
                    </div>

                    <div id="fanCurveEditor" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span></span>
                            <button onclick="resetFanCurve()" style="font-size: 0.8em; padding: 2px 8px;">Reset Defaults</button>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <strong style="font-size: 0.85em;">Temperature Curve</strong>
                            <table id="tempCurveTable" style="width: 100%; margin-top: 5px; font-size: 0.85em;">
                                <thead>
                                    <tr><th style="text-align: left;">Temp (C)</th><th>Fan %</th><th></th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <button onclick="addTempPoint()" style="font-size: 0.8em; margin-top: 5px;">+ Add Point</button>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <strong style="font-size: 0.85em;">Humidity Curve</strong>
                            <table id="humCurveTable" style="width: 100%; margin-top: 5px; font-size: 0.85em;">
                                <thead>
                                    <tr><th style="text-align: left;">Humidity %</th><th>Fan %</th><th></th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <button onclick="addHumPoint()" style="font-size: 0.8em; margin-top: 5px;">+ Add Point</button>
                        </div>

                        <button onclick="saveFanCurve()" style="width: 100%; margin-top: 10px;">Save Curve</button>
                    </div>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="firmwareRestart()" style="border-color: #ff6b6b; color: #ff6b6b;">Restart Firmware</button>
                </div>
            </section>

            <!-- Teensy Menu -->
            <section class="panel">
                <h2>Teensy Menu</h2>
                <div id="teensyMenuControls">
                    <p><em>Waiting for schema...</em></p>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button onclick="teensyRefresh()">Refresh</button>
                    <button onclick="teensySave()" id="teensySaveBtn">Save to EEPROM</button>
                </div>
            </section>

            <!-- Display Preview -->
            <section class="panel">
                <h2>Display Preview</h2>
                <div class="preview-controls">
                    <label>
                        <input type="checkbox" id="enablePreview" onchange="togglePreview()">
                        <span>Enable Live Preview</span>
                    </label>
                    <span id="previewFps"></span>
                </div>
                <div id="previewContainer" style="display: none;">
                    <video id="previewVideo" autoplay playsinline muted style="width: 100%;"></video>
                    <p><small>â—¢ Left Display | Right Display â—£</small></p>
                </div>
            </section>

            <!-- Shader Parameters -->
            <section class="panel shader-panel">
                <h2>Shader Parameters</h2>
                <p class="hint">Select animation to adjust parameters</p>

                <!-- Slider Physics Controls -->
                <div
                    style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                    <h3 style="margin: 0 0 15px 0; color: var(--accent-primary); font-size: 1.1em;">Slider Physics</h3>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="physicsEnabled" checked onchange="togglePhysics(this.checked)">
                            <span>Enable Slider Physics</span>
                        </label>
                        <small>Toggle momentum and damping effects</small>
                    </div>
                    <div class="input-group">
                        <label for="dampingSlider">Damping: <span id="dampingValue">8.0</span></label>
                        <input type="range" id="dampingSlider" min="0" max="20" step="0.5" value="8"
                            oninput="updateDamping(this.value)">
                        <small>Higher values = more resistance to movement</small>
                    </div>
                    <div class="input-group">
                        <label for="springSlider">Spring Force: <span id="springValue">15.0</span></label>
                        <input type="range" id="springSlider" min="5" max="50" step="1" value="15"
                            oninput="updateSpring(this.value)">
                        <small>Higher values = stronger pull toward target</small>
                    </div>
                </div>

                <div id="uniformControls">
                    <p><em>No animation selected...</em></p>
                </div>
            </section>
        </div>
    </div>

    <!-- MQTT Rate Monitor -->
    <div id="mqttRate">MQTT: 0 msg/s</div>

    <!-- JavaScript Modules (loaded in dependency order) -->
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mqtt.js') }}"></script>
    <script src="{{ url_for('static', filename='js/animations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/slider.js') }}"></script>
    <script src="{{ url_for('static', filename='js/uniforms.js') }}"></script>
    <script src="{{ url_for('static', filename='js/preview.js') }}"></script>
    <script src="{{ url_for('static', filename='js/fps-monitor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file_browser.js') }}"></script>
    <script src="{{ url_for('static', filename='js/system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/teensy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/presets.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>