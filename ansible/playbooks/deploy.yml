---
- name: Complete Protosuit Engine Deployment
  hosts: protosuit
  become: yes
  gather_facts: yes

  tasks:
    - name: Include display configuration tasks
      include_tasks: display-config.yml

    - name: Include main setup tasks
      include_tasks: main.yml

    - name: Verify mosquitto is running
      systemd:
        name: mosquitto
        state: started
        enabled: yes

    - name: Verify protosuit services are running
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - protosuit-renderer
        - protosuit-launcher
        - protosuit-web
        - protosuit-bluetoothbridge
        - protosuit-networkingbridge
        - protosuit-espbridge

    - name: Test MQTT connection
      shell: |
        timeout 5 mosquitto_sub -t "protogen/fins/#" -C 1 || true
      register: mqtt_test
      failed_when: false

    - name: Display deployment status
      debug:
        msg: |
          Protosuit Engine deployment completed successfully!

          Service Status:
          - Mosquitto MQTT Broker: Running
          - Protosuit Renderer: Running
          - Protosuit Launcher: Running
          - Protosuit Web: Running
          - Protosuit Bluetooth Bridge: Running
          - Protosuit Networking Bridge: Running
          - Protosuit ESP Bridge: Running

          Configuration:
          - Project Directory: {{ project_dir }}
          - Display Resolution: {{ display_width }}x{{ display_height }}
          - MQTT Broker: {{ mqtt_broker }}:{{ mqtt_port }}

          Test Commands:
          - Check services: sudo systemctl status protosuit-renderer protosuit-launcher protosuit-web protosuit-bluetoothbridge protosuit-networkingbridge
          - View logs: sudo journalctl -u protosuit-renderer -u protosuit-launcher -f

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart mosquitto
      systemd:
        name: mosquitto
        state: restarted

    - name: reload networkmanager
      systemd:
        name: NetworkManager
        state: reloaded
