---
# Main setup tasks for Protosuit Engine
# This file is included by other playbooks

- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install system packages
  apt:
    name: "{{ system_packages }}"
    state: present
    update_cache: yes

- name: Install PyGObject/pydbus build dependencies for D-Bus integration
  apt:
    name:
      - libgirepository-2.0-dev
      - libcairo2-dev
      - pkg-config
    state: present

- name: Configure Mosquitto for WebSocket support
  copy:
    dest: /etc/mosquitto/conf.d/websockets.conf
    content: |
      # WebSocket support for browser clients (accessible from all interfaces)
      listener 9001 0.0.0.0
      protocol websockets
      allow_anonymous true

      # Standard MQTT port (accessible from all interfaces)
      listener 1883 0.0.0.0
      protocol mqtt
      allow_anonymous true
    mode: "0644"
  notify: restart mosquitto

- name: Disable NetworkManager-wait-online to avoid boot timeout without Wi-Fi
  systemd:
    name: NetworkManager-wait-online.service
    enabled: no
    masked: yes

- name: Enable lingering for user so PulseAudio starts at boot without login
  command: loginctl enable-linger {{ pi_user }}
  changed_when: false

- name: Ensure mosquitto service is enabled and started
  systemd:
    name: mosquitto
    enabled: yes
    state: started

- name: Create Python virtual environment
  command: python3 -m venv "{{ project_dir }}/env"
  become_user: "{{ pi_user }}"
  args:
    creates: "{{ project_dir }}/env/bin/python"

- name: Install Python packages in virtual environment
  command: "env/bin/pip install -r requirements.txt"
  become_user: "{{ pi_user }}"
  args:
    chdir: "{{ project_dir }}"

# Include Super Haxagon tasks
- name: Include Super Haxagon installation tasks
  include_tasks: superhaxagon_tasks.yml

# Download custom Doom WAD for deathmatch
- name: Create WAD directory
  file:
    path: /usr/share/games/doom/wads
    state: directory
    mode: '0755'

- name: Download custom deathmatch WAD
  get_url:
    url: "https://archive.org/download/wadarchive/DATA/a4.zip/a4%2F52e5e6b94a19a1e88e3f991ac5803333fd75b6%2Fa452e5e6b94a19a1e88e3f991ac5803333fd75b6.wad.gz"
    dest: /usr/share/games/doom/duelpack.wad.gz
    mode: '0644'

- name: Extract WAD file
  shell: gunzip -c /usr/share/games/doom/duelpack.wad.gz > /usr/share/games/doom/duelpack.wad
  args:
    creates: /usr/share/games/doom/wads/duelpack.wad

- name: Remove compressed WAD file
  file:
    path: /usr/share/games/doom/duelpack.wad.gz
    state: absent

- name: Set zsh as default shell for pi user
  user:
    name: "{{ pi_user }}"
    shell: /usr/bin/zsh

- name: Check if Oh My Zsh is already installed
  stat:
    path: "/home/{{ pi_user }}/.oh-my-zsh"
  register: ohmyzsh_stat

- name: Install Oh My Zsh
  shell: |
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  become_user: "{{ pi_user }}"
  when: not ohmyzsh_stat.stat.exists

- name: Set Oh My Zsh theme to robbyrussell
  lineinfile:
    path: "/home/{{ pi_user }}/.zshrc"
    regexp: '^ZSH_THEME='
    line: 'ZSH_THEME="robbyrussell"'
    owner: "{{ pi_user }}"
    group: "{{ pi_user }}"

- name: Create protosuit-renderer systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-renderer.service.j2"
    dest: /etc/systemd/system/protosuit-renderer.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-launcher systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-launcher.service.j2"
    dest: /etc/systemd/system/protosuit-launcher.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-web systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-web.service.j2"
    dest: /etc/systemd/system/protosuit-web.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-bluetoothbridge systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-bluetoothbridge.service.j2"
    dest: /etc/systemd/system/protosuit-bluetoothbridge.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-networkingbridge systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-networkingbridge.service.j2"
    dest: /etc/systemd/system/protosuit-networkingbridge.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-castbridge systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-castbridge.service.j2"
    dest: /etc/systemd/system/protosuit-castbridge.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-controllerbridge systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-controllerbridge.service.j2"
    dest: /etc/systemd/system/protosuit-controllerbridge.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-audiobridge systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-audiobridge.service.j2"
    dest: /etc/systemd/system/protosuit-audiobridge.service
    mode: "0644"
  notify: reload systemd

- name: Create protosuit-espbridge systemd service file
  template:
    src: "{{ playbook_dir }}/../templates/protosuit-espbridge.service.j2"
    dest: /etc/systemd/system/protosuit-espbridge.service
    mode: "0644"
  notify: reload systemd

- name: Add user to dialout group for ESP32 serial access
  user:
    name: "{{ pi_user }}"
    groups: dialout
    append: yes

# Cast Bridge dependencies (AirPlay + Spotify Connect)
- name: Install shairport-sync for AirPlay support
  apt:
    name: shairport-sync
    state: present

- name: Deploy shairport-sync D-Bus policy for volume control
  template:
    src: "{{ playbook_dir }}/../templates/shairport-sync-dbus-policy.conf.j2"
    dest: /usr/share/dbus-1/system.d/shairport-sync-dbus-policy.conf
    mode: '0644'

- name: Download spotifyd binary (aarch64, PulseAudio + MPRIS)
  get_url:
    url: https://github.com/Spotifyd/spotifyd/releases/download/v0.4.2/spotifyd-linux-aarch64-full.tar.gz
    dest: /tmp/spotifyd.tar.gz
    mode: '0644'

- name: Extract spotifyd binary
  unarchive:
    src: /tmp/spotifyd.tar.gz
    dest: /usr/local/bin/
    remote_src: yes
    mode: '0755'

- name: Remove spotifyd tarball
  file:
    path: /tmp/spotifyd.tar.gz
    state: absent

- name: Check if libssl1.1 is installed (needed by spotifyd pre-built binary)
  shell: dpkg -s libssl1.1 2>/dev/null | grep -q 'Status.*installed'
  register: libssl1_check
  changed_when: false
  failed_when: false

- name: Install libssl1.1 from Debian 11 security repo
  apt:
    deb: http://security.debian.org/debian-security/pool/updates/main/o/openssl/libssl1.1_1.1.1w-0+deb11u4_arm64.deb
  when: libssl1_check.rc != 0

- name: Deploy spotifyd systemd service
  template:
    src: "{{ playbook_dir }}/../templates/spotifyd.service.j2"
    dest: /etc/systemd/system/spotifyd.service
    mode: '0644'
  notify: reload systemd

- name: Deploy spotifyd D-Bus policy for MPRIS on system bus
  template:
    src: "{{ playbook_dir }}/../templates/spotifyd-dbus-policy.conf.j2"
    dest: /usr/share/dbus-1/system.d/spotifyd-dbus-policy.conf
    mode: '0644'


- name: Create shairport-sync systemd override directory
  file:
    path: /etc/systemd/system/shairport-sync.service.d
    state: directory
    mode: '0755'

- name: Configure shairport-sync to run as user with PulseAudio access
  copy:
    dest: /etc/systemd/system/shairport-sync.service.d/override.conf
    content: |
      [Unit]
      After=mosquitto.service
      Wants=mosquitto.service
      StartLimitBurst=0

      [Service]
      User={{ pi_user }}
      Group={{ pi_user }}
      Environment=XDG_RUNTIME_DIR=/run/user/1000
      Environment=PULSE_SERVER=unix:/run/user/1000/pulse/native
      RestartSec=3
    mode: '0644'
  notify: reload systemd


- name: Reset shairport-sync defaults (clear DAEMON_ARGS override)
  copy:
    dest: /etc/default/shairport-sync
    content: |
      # shairport-sync uses /etc/shairport-sync.conf by default
      DAEMON_ARGS=""
    mode: '0644'

- name: Deploy default shairport-sync config
  template:
    src: "{{ playbook_dir }}/../templates/shairport-sync.conf.j2"
    dest: /etc/shairport-sync.conf
    mode: '0644'
    force: yes

- name: Deploy default spotifyd config
  template:
    src: "{{ playbook_dir }}/../templates/spotifyd.conf.j2"
    dest: /etc/spotifyd.conf
    mode: '0644'
    force: yes

- name: Create polkit rule for service management via D-Bus
  template:
    src: "{{ playbook_dir }}/../templates/50-protosuit-services.rules.j2"
    dest: /etc/polkit-1/rules.d/50-protosuit-services.rules
    mode: '0644'

- name: Allow user to write cast service config files without password
  copy:
    dest: /etc/sudoers.d/protosuit-cast
    content: |
      # Allow protosuit user to read/write config files for cast services
      # systemctl operations are handled via D-Bus + polkit (no sudo needed)
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/bin/tee /etc/shairport-sync.conf
      {{ pi_user }} ALL=(ALL) NOPASSWD: /bin/cat /etc/shairport-sync.conf
      {{ pi_user }} ALL=(ALL) NOPASSWD: /bin/chmod 644 /etc/shairport-sync.conf
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/bin/tee /etc/spotifyd.conf
      {{ pi_user }} ALL=(ALL) NOPASSWD: /bin/cat /etc/spotifyd.conf
      {{ pi_user }} ALL=(ALL) NOPASSWD: /bin/chmod 644 /etc/spotifyd.conf
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Add user to audio group for cast services
  user:
    name: "{{ pi_user }}"
    groups: audio
    append: yes

- name: Install audio capture dependencies for FFT visualization
  apt:
    name:
      - libportaudio2
    state: present

- name: Install networking packages for AP mode
  apt:
    name:
      - iptables
      - dnsmasq
      - hostapd
      - network-manager
    state: present

- name: Ensure hostapd service is stopped (managed by networkingbridge via D-Bus)
  systemd:
    name: hostapd
    enabled: no
    state: stopped
    masked: no
  ignore_errors: yes

- name: Ensure dnsmasq service is stopped (managed by networkingbridge via D-Bus)
  systemd:
    name: dnsmasq
    enabled: no
    state: stopped
    masked: no
  ignore_errors: yes

- name: Create hostapd systemd drop-in override directory
  file:
    path: /etc/systemd/system/hostapd.service.d
    state: directory
    mode: '0755'

- name: Deploy hostapd systemd drop-in override
  template:
    src: "{{ playbook_dir }}/../templates/hostapd-override.conf.j2"
    dest: /etc/systemd/system/hostapd.service.d/override.conf
    mode: '0644'

- name: Create dnsmasq systemd drop-in override directory
  file:
    path: /etc/systemd/system/dnsmasq.service.d
    state: directory
    mode: '0755'

- name: Deploy dnsmasq systemd drop-in override
  template:
    src: "{{ playbook_dir }}/../templates/dnsmasq-override.conf.j2"
    dest: /etc/systemd/system/dnsmasq.service.d/override.conf
    mode: '0644'

- name: Create AP scripts directory
  file:
    path: "{{ project_dir }}/scripts"
    state: directory
    mode: '0755'
    owner: "{{ pi_user }}"
    group: "{{ pi_user }}"

- name: Deploy AP management scripts
  template:
    src: "{{ playbook_dir }}/../templates/{{ item.src }}"
    dest: "{{ project_dir }}/scripts/{{ item.dest }}"
    mode: '0755'
  loop:
    - { src: "protosuit-ap-setup.sh.j2", dest: "ap-setup.sh" }
    - { src: "protosuit-ap-teardown.sh.j2", dest: "ap-teardown.sh" }
    - { src: "protosuit-routing-setup.sh.j2", dest: "routing-setup.sh" }
    - { src: "protosuit-routing-teardown.sh.j2", dest: "routing-teardown.sh" }

- name: Create protosuit config directory for AP environment
  file:
    path: /etc/protosuit
    state: directory
    mode: '0755'

- name: Reload systemd after deploying drop-in overrides
  systemd:
    daemon_reload: yes

- name: Disable ModemManager (interferes with Bluetooth pairing)
  systemd:
    name: ModemManager
    enabled: no
    state: stopped
  ignore_errors: yes

- name: Ensure NetworkManager is enabled and running
  systemd:
    name: NetworkManager
    enabled: yes
    state: started

- name: Create polkit rule for NetworkManager access
  copy:
    dest: /etc/polkit-1/rules.d/50-allow-network-manager.rules
    content: |
      polkit.addRule(function(action, subject) {
          if (action.id.indexOf("org.freedesktop.NetworkManager.") == 0 &&
              subject.user == "{{ pi_user }}") {
              return polkit.Result.YES;
          }
      });
    mode: '0644'

- name: Allow user to manage network services without password
  copy:
    dest: /etc/sudoers.d/protosuit-networking
    content: |
      # Allow protosuit user to manage network services and interfaces without password
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/bin/nmcli
      {{ pi_user }} ALL=(ALL) NOPASSWD: /sbin/ip
      {{ pi_user }} ALL=(ALL) NOPASSWD: /sbin/iptables
      {{ pi_user }} ALL=(ALL) NOPASSWD: /sbin/sysctl
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/sbin/dnsmasq
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/sbin/hostapd
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/bin/pkill
      {{ pi_user }} ALL=(ALL) NOPASSWD: /sbin/rmmod 8851bu
      {{ pi_user }} ALL=(ALL) NOPASSWD: /sbin/modprobe 8851bu
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Add user to netdev group for network management
  user:
    name: "{{ pi_user }}"
    groups: netdev
    append: yes

- name: Copy Python binary for privileged port binding
  copy:
    src: /usr/bin/python3
    dest: "{{ project_dir }}/env/bin/python3-privileged"
    remote_src: yes
    mode: '0755'
    owner: "{{ pi_user }}"
    group: "{{ pi_user }}"

- name: Allow Python to bind to privileged ports (for web server on port 80)
  community.general.capabilities:
    path: "{{ project_dir }}/env/bin/python3-privileged"
    capability: cap_net_bind_service+ep
    state: present

- name: Download OUI database if not exists
  get_url:
    url: https://standards-oui.ieee.org/oui/oui.txt
    dest: "{{ project_dir }}/engine/data/oui.txt"
    mode: '0644'
    timeout: 60
  become_user: "{{ pi_user }}"
  ignore_errors: yes

# RTL8851BU USB Wi-Fi driver installation (using rtw89 driver from morrownr)
- name: Check if rtw89 RTL8851BU driver is installed
  shell: "modinfo rtw89_8851bu_git 2>/dev/null || echo 'not found'"
  register: rtl8851bu_driver
  changed_when: false

- name: Install rtw89 driver dependencies
  apt:
    name:
      - git
      - build-essential
      - dkms
      - bc
    state: present
  when: "'not found' in rtl8851bu_driver.stdout"

- name: Clone rtw89 driver repository
  git:
    repo: https://github.com/morrownr/rtw89.git
    dest: /tmp/rtw89
    version: main
    force: yes
  become_user: "{{ pi_user }}"
  when: "'not found' in rtl8851bu_driver.stdout"

- name: Clean up conflicting drivers
  command: make cleanup_target_system
  args:
    chdir: /tmp/rtw89
  ignore_errors: yes
  when: "'not found' in rtl8851bu_driver.stdout"

- name: Build rtw89 driver
  command: make -j4
  args:
    chdir: /tmp/rtw89
  when: "'not found' in rtl8851bu_driver.stdout"

- name: Install rtw89 driver
  command: make install
  args:
    chdir: /tmp/rtw89
  when: "'not found' in rtl8851bu_driver.stdout"

- name: Install rtw89 firmware
  command: make install_fw
  args:
    chdir: /tmp/rtw89
  when: "'not found' in rtl8851bu_driver.stdout"

- name: Load RTL8851BU driver module
  modprobe:
    name: rtw89_8851bu_git
    state: present
  ignore_errors: yes

- name: Ensure RTL8851BU driver loads on boot
  lineinfile:
    path: /etc/modules-load.d/rtl8851bu.conf
    line: rtw89_8851bu_git
    create: yes
    mode: '0644'

- name: Clean up rtw89 build directory
  file:
    path: /tmp/rtw89
    state: absent
  when: "'not found' in rtl8851bu_driver.stdout"

- name: Add user to bluetooth and input groups
  user:
    name: "{{ pi_user }}"
    groups: bluetooth,input
    append: yes

- name: Allow user to manage Bluetooth service without password
  copy:
    dest: /etc/sudoers.d/protosuit-bluetooth
    content: |
      # Allow protosuit user to restart Bluetooth service and manage adapters without password
      {{ pi_user }} ALL=(ALL) NOPASSWD: /bin/systemctl restart bluetooth
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/bin/hciconfig
      {{ pi_user }} ALL=(ALL) NOPASSWD: /usr/sbin/rfkill
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Unblock Bluetooth via rfkill
  command: rfkill unblock bluetooth
  changed_when: false

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Set system to boot to graphical target
  command: systemctl set-default graphical.target
  become: true

- name: Remove legacy protosuit-engine service file
  file:
    path: /etc/systemd/system/protosuit-engine.service
    state: absent
  notify: reload systemd

- name: Enable protosuit-renderer service
  systemd:
    name: protosuit-renderer
    enabled: yes

- name: Enable protosuit-launcher service
  systemd:
    name: protosuit-launcher
    enabled: yes

- name: Enable protosuit-web service
  systemd:
    name: protosuit-web
    enabled: yes

- name: Enable protosuit-bluetoothbridge service
  systemd:
    name: protosuit-bluetoothbridge
    enabled: yes

- name: Enable protosuit-networkingbridge service
  systemd:
    name: protosuit-networkingbridge
    enabled: yes

- name: Enable protosuit-castbridge service
  systemd:
    name: protosuit-castbridge
    enabled: yes

- name: Enable protosuit-controllerbridge service
  systemd:
    name: protosuit-controllerbridge
    enabled: yes

- name: Enable protosuit-audiobridge service
  systemd:
    name: protosuit-audiobridge
    enabled: yes

- name: Enable protosuit-espbridge service
  systemd:
    name: protosuit-espbridge
    enabled: yes

- name: Start all protosuit services
  systemd:
    name: "{{ item }}"
    state: started
  loop:
    - protosuit-renderer
    - protosuit-launcher
    - protosuit-web
    - protosuit-bluetoothbridge
    - protosuit-controllerbridge
    - protosuit-audiobridge
    - protosuit-networkingbridge
    - protosuit-castbridge
    - protosuit-espbridge