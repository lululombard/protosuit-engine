#!/bin/bash
# X Server startup script for Protosuit Engine
# This script starts X server and configures dual displays

set -e

# Kill any existing X processes
pkill -f "X :0" || true
sleep 0.5

# Start X server in background
export DISPLAY=:0
nohup startx -- :0 > /var/log/xserver.log 2>&1 &

# Wait for X server to start
for i in {1..30}; do
    if xset q >/dev/null 2>&1; then
        echo "X server started successfully"
        break
    fi
    echo "Waiting for X server... ($i/30)"
    sleep 1
done

# Configure displays with correct rotation
echo "Configuring dual displays..."

# Left fin
xrandr --output {{ display_config.left.name }} --mode {{ display_config.left.resolution }} --pos {{ display_config.left.position }} --rotate {{ display_config.left.rotation }} || echo "Failed to configure {{ display_config.left.name }}"

# Right fin
xrandr --output {{ display_config.right.name }} --mode {{ display_config.right.resolution }} --pos {{ display_config.right.position }} --rotate {{ display_config.right.rotation }} || echo "Failed to configure {{ display_config.right.name }}"

# Set left fin as primary
xrandr --output {{ display_config.left.name }} --primary || echo "Failed to set {{ display_config.left.name }} as primary"

# Disable screen blanking and power management
xset s off
xset -dpms
xset s noblank

# Allow local connections to X server
xhost +local:

# Hide the mouse cursor
unclutter -idle 0.01 -root &

# Start picom compositor for vsync (V3D driver needs a compositor for tear-free rendering)
if command -v picom >/dev/null 2>&1; then
    picom --backend glx --vsync --no-fading-openclose --no-fading-destroyed-argb -b &
    echo "picom compositor started"
else
    echo "WARNING: picom not installed, vsync will not work"
fi

echo "Display configuration complete"
